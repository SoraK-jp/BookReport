# 読書感想文生成アプリケーション - 完全ドキュメント

[Mermaid設計図](./Mermaid設計図.md)

## 📋 目次

1. [システム概要](#システム概要)
2. [アーキテクチャ設計](#アーキテクチャ設計)
3. [セットアップ手順](#セットアップ手順)
4. [操作マニュアル](#操作マニュアル)
5. [API仕様](#api仕様)
6. [設定ガイド](#設定ガイド)
7. [エラーハンドリング](#エラーハンドリング)
8. [トラブルシューティング](#トラブルシューティング)

---

## システム概要

### 概要

Google Gemini APIを活用した、AI駆動の読書感想文自動生成Webアプリケーションです。ユーザーが書籍情報と感想の焦点を入力すると、約400文字の構造化された読書感想文を自動生成します。

### 主な機能

- **書籍情報入力**: タイトル、著者名、感想の焦点を指定
- **AI生成**: Gemini 2.5 Flashモデルによる高品質な文章生成
- **Google検索統合**: Grounding機能により正確な書籍情報を取得
- **文字数制御**: 380〜420文字の範囲で自動調整
- **構造化出力**: 導入・本文・結論の3部構成

### 技術スタック

| レイヤー | 技術 |
|---------|------|
| **フロントエンド** | HTML5, CSS3, Vanilla JavaScript |
| **バックエンド** | Node.js (v18+), Express.js 5.2+ |
| **AI/ML** | Google Gemini 2.5 Flash API |
| **パッケージ管理** | npm |
| **環境変数管理** | dotenv |
| **開発ツール** | nodemon (ホットリロード) |

---

## アーキテクチャ設計

### システムアーキテクチャ図

```
┌─────────────────┐
│   ユーザー      │
└────────┬────────┘
         │ HTTP
         ▼
┌─────────────────────────────┐
│  フロントエンド (Public/)   │
│  ┌─────────────────────┐   │
│  │  index.html         │   │
│  │  css/style.css      │   │
│  │  js/app.js          │   │
│  └─────────────────────┘   │
└──────────┬──────────────────┘
           │ POST /api/generate-review
           ▼
┌─────────────────────────────┐
│  バックエンド (server.js)   │
│  ┌─────────────────────┐   │
│  │  Express Router     │   │
│  │  ├─ Validation      │   │
│  │  ├─ Prompt Builder  │   │
│  │  └─ Error Handler   │   │
│  └─────────────────────┘   │
└──────────┬──────────────────┘
           │ API Call
           ▼
┌─────────────────────────────┐
│  Gemini API                 │
│  ┌─────────────────────┐   │
│  │  Gemini 2.5 Flash   │   │
│  │  + Google Search    │   │
│  └─────────────────────┘   │
└─────────────────────────────┘
```

### データフロー図

```
[入力] → [検証] → [プロンプト生成] → [AI処理] → [テキスト抽出] → [出力]
   │        │           │              │            │             │
   │        └─NG────→ [エラー]         │            │             │
   │                                   └─失敗───→ [エラー]        │
   └──────────────────────────────────────────────────────────→ [UI表示]
```

### コンポーネント構成

#### バックエンド主要コンポーネント

1. **Express Server**
   - ルーティング管理
   - 静的ファイル配信
   - ミドルウェア処理

2. **Validation Layer**
   - 入力値の妥当性検証
   - 文字数制限チェック
   - 必須項目チェック

3. **Prompt Builder**
   - システム命令の構築
   - ユーザー入力の整形
   - 文字数指定の組み込み

4. **Gemini API Client**
   - API認証
   - リクエスト送信
   - レスポンス解析

5. **Error Handler**
   - エラー分類
   - エラーメッセージ生成
   - HTTPステータスコード管理

---

## セットアップ手順

### 前提条件

- Node.js v18.0.0以上
- npm (Node.jsに同梱)
- Gemini APIキー ([取得方法](https://aistudio.google.com/app/apikey))

### インストール手順

#### ステップ1: プロジェクトのクローン/ダウンロード

```bash
# プロジェクトディレクトリに移動
cd BookReport
```

#### ステップ2: 依存パッケージのインストール

```bash
npm install
```

**インストールされるパッケージ:**

```json
{
  "dependencies": {
    "@google/generative-ai": "^0.21.0",
    "dotenv": "^16.4.5",
    "express": "^5.2.1"
  },
  "devDependencies": {
    "nodemon": "^3.1.9"
  }
}
```

#### ステップ3: 環境変数の設定

1. `sample.env`を`.env`にコピー:

```bash
# Windows
copy sample.env .env

# macOS/Linux
cp sample.env .env
```

2. `.env`ファイルを編集:

```env
# Gemini API Key
GEMINI_API_KEY=YOUR_ACTUAL_API_KEY_HERE

# Server Configuration
PORT=3000
NODE_ENV=development

# Optional: Enable detailed logging
DEBUG=false
```

**重要:** `YOUR_ACTUAL_API_KEY_HERE`を実際のAPIキーに置き換えてください。

#### ステップ4: サーバー起動

**本番モード:**
```bash
npm start
```

**開発モード (ホットリロード有効):**
```bash
npm run dev
```

#### ステップ5: 動作確認

1. ブラウザで `http://localhost:3000` にアクセス
2. ヘルスチェック: `http://localhost:3000/api/health`

**期待される応答:**
```json
{
  "status": "ok",
  "timestamp": "2026-01-19T12:00:00.000Z",
  "geminiConfigured": true,
  "nodeEnv": "development"
}
```

---

## 操作マニュアル

### 基本操作

#### 1. 書籍情報の入力

**タイトル (必須)**
- 書籍の正式名称を入力
- 最大200文字
- 例: `人間失格`

**著者名 (任意)**
- 著者のフルネームを入力
- 同名書籍の判別に有効
- 例: `太宰治`

#### 2. 感想文の焦点設定 (必須)

どのような視点で感想文を書いてほしいかを具体的に記述します。

**入力例:**

| 焦点タイプ | 入力例 |
|-----------|--------|
| **テーマ分析** | `主人公の心の成長と葛藤について` |
| **社会問題** | `物語に描かれている貧困問題について` |
| **個人的共感** | `自分の経験と重ね合わせて感じたこと` |
| **文学的技法** | `作者の描写技法と心理描写について` |
| **特定シーン** | `ラストシーンから感じた希望について` |

#### 3. 生成実行

1. 「読書感想文を生成する」ボタンをクリック
2. 生成中は「生成中...」と表示
3. 5〜15秒で完成 (通常10秒以内)

#### 4. 結果の活用

- 生成されたテキストをコピー&ペースト
- 必要に応じて手動で編集・加筆
- 再生成も可能 (異なる焦点で試す)

### 高度な活用法

#### パターン1: 多角的分析

同じ書籍で複数の焦点を試し、最も良い視点を選択:

1. 「主人公の成長」で生成
2. 「社会背景」で生成
3. 「文学的価値」で生成
4. 最適なものを選択・統合

#### パターン2: 段階的改善

1. 簡潔な焦点で初回生成
2. 結果を見て焦点を詳細化
3. 再生成で精度向上

---

## API仕様

### エンドポイント一覧

#### 1. 読書感想文生成API

**エンドポイント:** `POST /api/generate-review`

**リクエスト仕様:**

```http
POST /api/generate-review HTTP/1.1
Content-Type: application/json

{
  "title": "人間失格",
  "author": "太宰治",
  "focus": "主人公の心の葛藤と現代社会への示唆"
}
```

**リクエストパラメータ:**

| パラメータ | 型 | 必須 | 最大長 | 説明 |
|-----------|-----|------|--------|------|
| `title` | string | ✓ | 200 | 書籍タイトル |
| `author` | string | - | - | 著者名 |
| `focus` | string | ✓ | 500 | 感想文の焦点 |

**成功レスポンス (200 OK):**

```json
{
  "text": "太宰治の『人間失格』は、人間の内面...(省略)...考えさせられた一冊でした。",
  "metadata": {
    "characterCount": 395,
    "model": "gemini-2.5-flash",
    "searchUsed": true
  }
}
```

**エラーレスポンス:**

```json
// 400 Bad Request - バリデーションエラー
{
  "error": "タイトルと焦点は必須です。",
  "details": ["タイトルと焦点は必須です。"],
  "required": ["title", "focus"]
}

// 401 Unauthorized - APIキーエラー
{
  "error": "APIキーが無効です。管理者に連絡してください。"
}

// 429 Too Many Requests - レート制限
{
  "error": "リクエスト制限に達しました。しばらく待ってから再試行してください。"
}

// 400 Bad Request - 安全性フィルター
{
  "error": "コンテンツが安全性フィルターによってブロックされました。別の焦点や表現で再試行してください。"
}

// 500 Internal Server Error - サーバーエラー
{
  "error": "感想文の生成中にエラーが発生しました。",
  "details": "詳細メッセージ (開発モードのみ)"
}
```

#### 2. ヘルスチェックAPI

**エンドポイント:** `GET /api/health`

**レスポンス (200 OK):**

```json
{
  "status": "ok",
  "timestamp": "2026-01-19T12:00:00.000Z",
  "geminiConfigured": true,
  "nodeEnv": "development"
}
```

---

## 設定ガイド

### 環境変数詳細

#### 必須設定

**GEMINI_API_KEY**
- 説明: Google Gemini APIの認証キー
- 取得先: https://aistudio.google.com/app/apikey
- 形式: 英数字の文字列
- 例: `AIzaSyABC123def456GHI789jkl012MNO345pqr`

#### オプション設定

**PORT**
- 説明: サーバーのリスニングポート
- デフォルト: `3000`
- 変更例: `PORT=8080`

**NODE_ENV**
- 説明: 実行環境の指定
- 値: `development` | `production`
- 影響:
  - `development`: 詳細ログ出力、エラー詳細表示
  - `production`: 最小限のログ、セキュアなエラー応答

**DEBUG**
- 説明: デバッグログの有効化
- 値: `true` | `false`
- デフォルト: `false`

### Gemini API設定

#### モデルパラメータ (server.js内)

```javascript
const CONFIG = {
    GEMINI: {
        MODEL: 'gemini-2.5-flash',      // 使用モデル
        TEMPERATURE: 0.9,                // 創造性 (0.0-1.0)
        TOP_P: 0.95,                     // 確率分布の閾値
        TOP_K: 40,                       // サンプリング候補数
        MAX_TOKENS: 1024,                // 最大トークン数
    }
}
```

**パラメータ調整ガイド:**

| パラメータ | 低い値の効果 | 高い値の効果 | 推奨値 |
|-----------|-------------|-------------|--------|
| TEMPERATURE | 保守的・一貫性高 | 創造的・多様性高 | 0.9 |
| TOP_P | 確実性重視 | 多様性重視 | 0.95 |
| TOP_K | 安定性重視 | 創造性重視 | 40 |
| MAX_TOKENS | 短文 | 長文 | 1024 |

#### 文字数設定

```javascript
const CONFIG = {
    BOOK_REVIEW: {
        TARGET_CHAR_COUNT: 400,  // 目標文字数
        MIN_CHAR_COUNT: 380,     // 最小文字数
        MAX_CHAR_COUNT: 420,     // 最大文字数
    }
}
```

---

## エラーハンドリング

### エラー分類と対処法

#### クライアント側エラー (400番台)

**400 Bad Request - 入力検証エラー**

原因:
- 必須項目の未入力
- 文字数制限超過

対処法:
1. タイトルと焦点が入力されているか確認
2. タイトル200文字以内、焦点500文字以内に収める

**401 Unauthorized - API認証エラー**

原因:
- APIキーが無効または期限切れ

対処法:
1. `.env`ファイルのAPIキーを確認
2. 新しいAPIキーを取得して設定
3. サーバーを再起動

**429 Too Many Requests - レート制限**

原因:
- Gemini APIの無料枠超過
- 短時間に大量リクエスト

対処法:
1. 1〜2分待ってから再試行
2. 有料プランへのアップグレード検討

#### サーバー側エラー (500番台)

**500 Internal Server Error**

原因:
- Gemini APIの一時的障害
- ネットワークエラー
- プログラムのバグ

対処法:
1. サーバーログを確認
2. サーバー再起動を試す
3. Gemini APIのステータスページを確認

### ログの読み方

#### 正常時のログ

```
🚀 Server is running at http://localhost:3000
📚 Book Review Generator API is ready
🔧 Environment: development
📝 Generating review for: 人間失格
✅ Generated 395 characters
```

#### エラー時のログ

```
❌ Server Error: Error: API key not valid
Error stack: Error: API key not valid
    at ...

⚠️ Error extracting text: TypeError: Cannot read property 'text' of undefined
```

---

## トラブルシューティング

### よくある問題と解決策

#### 問題1: サーバーが起動しない

**症状:**
```
❌ Error: GEMINI_API_KEY is not set in environment variables
```

**解決策:**
1. `.env`ファイルが存在するか確認
2. `GEMINI_API_KEY`が正しく設定されているか確認
3. サーバーを再起動

---

#### 問題2: 生成が遅い・タイムアウト

**症状:**
- 30秒以上待っても結果が返らない

**解決策:**
1. ネットワーク接続を確認
2. Gemini APIのステータスを確認
3. 焦点の内容を簡潔にする
4. サーバーを再起動

---

####問題3: 不適切な内容でブロックされる

**症状:**
```
コンテンツが安全性フィルターによってブロックされました
```

**解決策:**
1. 焦点の表現を見直す
2. より中立的な言葉遣いに変更
3. 暴力的・性的な表現を避ける

---

#### 問題4: 生成される文字数が不安定

**症状:**
- 300文字や500文字になる

**解決策:**
1. `CONFIG.BOOK_REVIEW`の設定を確認
2. プロンプトの指示を強化
3. 複数回生成して最適なものを選択

---

### デバッグモードの有効化

開発モードで詳細ログを確認:

```bash
# .envファイルで設定
NODE_ENV=development
DEBUG=true

# サーバー再起動
npm run dev
```

詳細ログの出力例:
```
🔍 Full response: {
  "candidates": [...],
  "promptFeedback": {...}
}
```

---

## まとめ

このドキュメントでは、読書感想文生成アプリケーションの全体像を説明しました:

1. **システム概要**: AI駆動の感想文生成アプリ
2. **アーキテクチャ**: Express + Gemini APIの構成
3. **セットアップ**: 5ステップでの導入手順
4. **操作方法**: 3ステップでの感想文生成
5. **API仕様**: 詳細なエンドポイント仕様
6. **設定**: 環境変数とパラメータ調整
7. **エラー対応**: 包括的なトラブルシューティング

### 次のステップ

- フロントエンドのUI改善
- 複数書籍の一括処理機能
- 生成履歴の保存機能
- ユーザー認証の追加

### サポート

問題が解決しない場合は、以下を確認してください:

- [Gemini API公式ドキュメント](https://ai.google.dev/docs)
- [Express.js公式ドキュメント](https://expressjs.com/)
- GitHubリポジトリのIssues

---

**バージョン:** 1.0.0  
**最終更新:** 2026年1月19日  
**作成者:** Claude (Anthropic)
